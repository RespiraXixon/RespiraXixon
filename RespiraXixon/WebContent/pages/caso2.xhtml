<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets">

	<ui:composition template="/templates/plantilla.xhtml">
		<ui:define name="contenido">
			<div id="mapa">
				<script>
				var map;

				function inicializa_mapa(datos) {
					console.log(datos);
					// crea mapa
					map = new L.Map('mapa');

					// crea el layer
					var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
					var osmAttrib='Map data Â© OpenStreetMap contributors';
					var osm = new L.TileLayer(osmUrl, {minZoom: 8, maxZoom: 18, attribution: osmAttrib});		

					// Comenzamos el mapa en Gijon
					map.setView(new L.LatLng(43.5450394,-5.6626443),13);
					map.addLayer(osm);

					//Insertamos iconos
					
					var LeafIcon = L.Icon.extend({
						options: {
							iconSize:     [15, 35],
							iconAnchor:   [15, 35],
							popupAnchor:  [-3, -76]
						}
					});
					
					var semaforo_verde = new LeafIcon({iconUrl: '../images/semaforo_verde.jpg'});

					//Procesamos el jason
					$.each(datos.estaciones.estacion, function() {
					    console.log(this);
					    L.marker([this.latitud,this.longitud], {icon: semaforo_verde}).bindPopup(this.titulo).addTo(map);
					});
				}

	
				function lee_json() {
						 var inicio,fin=0;
						 var obj_json;
						 
						 var url='http://opendata.gijon.es/descargar.php?id=4&amp;tipo=JSON';

						 //Usamos la libreria jquery.xdomainajax.js
						 $.ajax({      
								    type: 'GET', 
								    async:false,                                                                                                                                                                                                
								    url: url,                                                                                                                                           
								    success: function(json) { 
									    //La respuesta viene con html. Dejamos el texto plano y lo parseamos
									    inicio=json.responseText.indexOf('<p>')+3;
									    fin=json.responseText.indexOf('</p>');
									    inicializa_mapa(jQuery.parseJSON(json.responseText.substring(inicio,fin)));
									},                                                                                                                                                                                       
								    error: function() { console.log('Error'); }							                                                                                                                                
								});			 
			        }
					
					lee_json();				
		</script>
			</div>
		</ui:define>
	</ui:composition>
</html>